<%- include('../../partials/header') %>

<h1>Nutrition Tracking</h1>

<!-- Nutrition Goals -->
<section>
  <h2>Nutrition Goals</h2>
  <%
    var p = (typeof userPreferences !== 'undefined' && userPreferences) ? userPreferences : {};
  %>
  <form method="POST" action="/nutrition/goals">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">

    <fieldset>
      <legend><strong>Macronutrients</strong></legend>
      <div class="grid">
        <div>
          <label for="calorieTarget">Calories</label>
          <input type="number" id="calorieTarget" name="calorieTarget" min="0" step="50" placeholder="e.g. 2000" value="<%= p.calorieTarget || '' %>">
        </div>
        <div>
          <label for="proteinTarget">Protein (g)</label>
          <input type="number" id="proteinTarget" name="proteinTarget" min="0" step="1" placeholder="e.g. 50" value="<%= p.proteinTarget || '' %>">
        </div>
        <div>
          <label for="fatTarget">Fat (g)</label>
          <input type="number" id="fatTarget" name="fatTarget" min="0" step="1" placeholder="e.g. 65" value="<%= p.fatTarget || '' %>">
        </div>
        <div>
          <label for="carbsTarget">Carbs (g)</label>
          <input type="number" id="carbsTarget" name="carbsTarget" min="0" step="1" placeholder="e.g. 300" value="<%= p.carbsTarget || '' %>">
        </div>
      </div>
    </fieldset>

    <fieldset>
      <legend><strong>Micronutrients</strong></legend>
      <div class="grid">
        <div>
          <label for="fiberTarget">Fiber (g)</label>
          <input type="number" id="fiberTarget" name="fiberTarget" min="0" step="1" placeholder="e.g. 25" value="<%= p.fiberTarget || '' %>">
        </div>
        <div>
          <label for="sugarTarget">Sugar (g)</label>
          <input type="number" id="sugarTarget" name="sugarTarget" min="0" step="1" placeholder="e.g. 50" value="<%= p.sugarTarget || '' %>">
        </div>
        <div>
          <label for="sodiumTarget">Sodium (mg)</label>
          <input type="number" id="sodiumTarget" name="sodiumTarget" min="0" step="10" placeholder="e.g. 2300" value="<%= p.sodiumTarget || '' %>">
        </div>
        <div>
          <label for="ironTarget">Iron (mg)</label>
          <input type="number" id="ironTarget" name="ironTarget" min="0" step="1" placeholder="e.g. 18" value="<%= p.ironTarget || '' %>">
        </div>
      </div>
      <div class="grid">
        <div>
          <label for="calciumTarget">Calcium (mg)</label>
          <input type="number" id="calciumTarget" name="calciumTarget" min="0" step="10" placeholder="e.g. 1000" value="<%= p.calciumTarget || '' %>">
        </div>
        <div>
          <label for="vitaminDTarget">Vitamin D (mcg)</label>
          <input type="number" id="vitaminDTarget" name="vitaminDTarget" min="0" step="1" placeholder="e.g. 15" value="<%= p.vitaminDTarget || '' %>">
        </div>
        <div>
          <label for="potassiumTarget">Potassium (mg)</label>
          <input type="number" id="potassiumTarget" name="potassiumTarget" min="0" step="10" placeholder="e.g. 2600" value="<%= p.potassiumTarget || '' %>">
        </div>
        <div>
          <label for="vitaminCTarget">Vitamin C (mg)</label>
          <input type="number" id="vitaminCTarget" name="vitaminCTarget" min="0" step="1" placeholder="e.g. 90" value="<%= p.vitaminCTarget || '' %>">
        </div>
      </div>
    </fieldset>

    <button type="submit">Save Goals</button>
  </form>
</section>

<!-- Weekly Summary -->
<section>
  <h2>Weekly Summary</h2>
  <% if (typeof weeklySummary !== 'undefined' && weeklySummary.length > 0) { %>
    <%
      var goals = [];
      if (p.calorieTarget) goals.push({ key: 'calories', label: 'Calories', unit: '', target: p.calorieTarget, css: 'calories' });
      if (p.proteinTarget) goals.push({ key: 'proteinG', label: 'Protein', unit: 'g', target: p.proteinTarget, css: 'protein' });
      if (p.fatTarget) goals.push({ key: 'fatG', label: 'Fat', unit: 'g', target: p.fatTarget, css: 'fat' });
      if (p.carbsTarget) goals.push({ key: 'carbsG', label: 'Carbs', unit: 'g', target: p.carbsTarget, css: 'carbs' });
      if (p.fiberTarget) goals.push({ key: 'fiberG', label: 'Fiber', unit: 'g', target: p.fiberTarget, css: 'fiber' });
      if (p.sugarTarget) goals.push({ key: 'sugarG', label: 'Sugar', unit: 'g', target: p.sugarTarget, css: 'sugar' });
      if (p.sodiumTarget) goals.push({ key: 'sodiumMg', label: 'Sodium', unit: 'mg', target: p.sodiumTarget, css: 'sodium' });
      if (p.ironTarget) goals.push({ key: 'ironMg', label: 'Iron', unit: 'mg', target: p.ironTarget, css: 'iron' });
      if (p.calciumTarget) goals.push({ key: 'calciumMg', label: 'Calcium', unit: 'mg', target: p.calciumTarget, css: 'calcium' });
      if (p.vitaminDTarget) goals.push({ key: 'vitaminDMcg', label: 'Vitamin D', unit: 'mcg', target: p.vitaminDTarget, css: 'vitaminD' });
      if (p.potassiumTarget) goals.push({ key: 'potassiumMg', label: 'Potassium', unit: 'mg', target: p.potassiumTarget, css: 'potassium' });
      if (p.vitaminCTarget) goals.push({ key: 'vitaminCMg', label: 'Vitamin C', unit: 'mg', target: p.vitaminCTarget, css: 'vitaminC' });

      // Fallback: if no goals set, show calories and protein with defaults
      if (goals.length === 0) {
        goals.push({ key: 'calories', label: 'Calories', unit: '', target: 2000, css: 'calories' });
        goals.push({ key: 'proteinG', label: 'Protein', unit: 'g', target: 50, css: 'protein' });
      }
    %>
    <figure>
      <table>
        <thead>
          <tr>
            <th>Date</th>
            <% goals.forEach(function(g) { %>
              <th><%= g.label %><% if (g.unit) { %> (<%= g.unit %>)<% } %></th>
            <% }); %>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <% weeklySummary.forEach(function(day) { %>
            <tr>
              <td>
                <a href="/nutrition/daily?date=<%= day.date %>"><%= new Date(day.date + 'T12:00:00').toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) %></a>
              </td>
              <% goals.forEach(function(g) { %>
                <td>
                  <div class="progress-bar progress-<%= g.css %>">
                    <div class="progress-fill" style="width: <%= Math.min((day.totals[g.key] / g.target) * 100, 100) %>%;">
                      <%= Math.round(day.totals[g.key]) %><%= g.unit %>
                    </div>
                  </div>
                </td>
              <% }); %>
              <td>
                <a href="/nutrition/daily?date=<%= day.date %>">Details</a>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </figure>
  <% } else { %>
    <p class="text-muted">No nutrition data logged this week. Go to <a href="/nutrition/daily">today's log</a> to start tracking!</p>
  <% } %>
</section>

<%- include('../../partials/footer') %>
