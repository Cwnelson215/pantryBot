<%- include('../../partials/header') %>

<div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4 mb-6">
  <h1 class="text-2xl font-bold text-gray-900 dark:text-white">Add Pantry Item</h1>
  <button type="button" id="scanBtn" onclick="openScanner()" class="btn-secondary">
    <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9V5a2 2 0 012-2h4M3 15v4a2 2 0 002 2h4m8-18h4a2 2 0 012 2v4m0 6v4a2 2 0 01-2 2h-4"/><line x1="7" y1="12" x2="17" y2="12"/></svg>
    Scan Barcode
  </button>
</div>

<div id="scanResult" style="display:none;" class="mb-4"></div>

<div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 shadow-sm p-6">
  <form method="POST" action="/pantry/add" class="space-y-4">
    <input type="hidden" name="_csrf" value="<%= csrfToken %>">
    <input type="hidden" id="barcode" name="barcode">

    <div>
      <label for="name" class="form-label">Name <span class="text-red-500">*</span></label>
      <input type="text" id="name" name="name" placeholder="e.g. Chicken Breast" required autofocus class="form-input">
    </div>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
      <div>
        <label for="quantity" class="form-label">Quantity</label>
        <input type="number" id="quantity" name="quantity" step="0.01" min="0" placeholder="1" class="form-input">
      </div>
      <div>
        <label for="unit" class="form-label">Unit</label>
        <select id="unit" name="unit" class="form-input">
          <option value="">-- Select --</option>
          <% if (typeof units !== 'undefined') { %>
            <% units.forEach(function(u) { %>
              <option value="<%= u %>"><%= u %></option>
            <% }); %>
          <% } %>
        </select>
      </div>
    </div>

    <div>
      <label for="category" class="form-label">Category</label>
      <select id="category" name="category" class="form-input">
        <option value="">-- Select --</option>
        <% if (typeof categories !== 'undefined') { %>
          <% categories.forEach(function(c) { %>
            <option value="<%= c %>"><%= c %></option>
          <% }); %>
        <% } %>
      </select>
    </div>

    <div>
      <label for="expirationDate" class="form-label">Expiration Date</label>
      <input type="date" id="expirationDate" name="expirationDate" class="form-input">
    </div>

    <div>
      <label for="notes" class="form-label">Notes</label>
      <textarea id="notes" name="notes" placeholder="Optional notes..." rows="3" class="form-input"></textarea>
    </div>

    <div class="flex flex-col sm:flex-row gap-3 pt-2">
      <button type="submit" class="btn-primary flex-1">Add Item</button>
      <a href="/pantry" class="btn-secondary flex-1 text-center">Cancel</a>
    </div>
  </form>
</div>

<!-- Barcode Scanner Dialog -->
<dialog id="scannerDialog" class="rounded-xl border border-gray-200 dark:border-gray-700 shadow-xl p-0 max-w-lg w-[90%] bg-white dark:bg-gray-800 backdrop:bg-gray-900/50">
  <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Scan Barcode</h3>
    <button onclick="closeScanner()" class="p-1 rounded-lg text-gray-500 hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors">&times;</button>
  </div>
  <div class="p-4">
    <div id="scannerStatus" class="text-center text-sm text-gray-500 dark:text-gray-400 mb-3"></div>
    <div id="reader"></div>
  </div>
  <div class="p-4 border-t border-gray-200 dark:border-gray-700">
    <button class="btn-secondary w-full" onclick="closeScanner()">Cancel</button>
  </div>
</dialog>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
(function() {
  var scanner = null;
  var scanning = false;
  var dialog = document.getElementById('scannerDialog');
  var scanBtn = document.getElementById('scanBtn');
  var statusEl = document.getElementById('scannerStatus');
  var resultEl = document.getElementById('scanResult');

  // Disable scan button if no camera API
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    scanBtn.textContent = 'Scanner Not Available';
    scanBtn.disabled = true;
  }

  window.openScanner = function() {
    scanning = false;
    dialog.showModal();
    statusEl.textContent = 'Starting camera...';

    scanner = new Html5Qrcode('reader');
    scanner.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: { width: 250, height: 150 }, formatsToSupport: [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E,
        Html5QrcodeSupportedFormats.CODE_128,
      ]},
      function(decodedText) {
        onBarcodeScanned(decodedText);
      },
      function() {}
    ).then(function() {
      statusEl.textContent = 'Point camera at a barcode';
    }).catch(function(err) {
      statusEl.textContent = 'Camera error: ' + (err.message || err);
    });
  };

  window.closeScanner = function() {
    var s = scanner;
    scanner = null;
    if (s) {
      try { s.stop().catch(function() {}); } catch(e) {}
      try { s.clear(); } catch(e) {}
    }
    dialog.close();
  };

  function onBarcodeScanned(barcode) {
    if (scanning) return;
    scanning = true;

    statusEl.innerHTML = '<span class="inline-flex items-center gap-2"><svg class="animate-spin h-4 w-4" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg>Looking up product...</span>';

    var controller = new AbortController();
    var timeoutId = setTimeout(function() { controller.abort(); }, 15000);

    fetch('/pantry/lookup-barcode/' + encodeURIComponent(barcode), { signal: controller.signal })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        clearTimeout(timeoutId);
        scanning = false;
        closeScanner();
        if (data.found) {
          prefillForm(data, barcode);
        } else {
          showResult('error', 'Product not found for barcode ' + barcode + '. Please enter details manually.');
        }
      })
      .catch(function(err) {
        clearTimeout(timeoutId);
        scanning = false;
        closeScanner();
        if (err.name === 'AbortError') {
          showResult('error', 'Barcode lookup timed out. Please enter details manually.');
        } else {
          showResult('error', 'Failed to look up barcode. Please enter details manually.');
        }
      });
  }

  function prefillForm(data, barcode) {
    document.getElementById('barcode').value = barcode;

    if (data.name) {
      document.getElementById('name').value = data.name;
    }
    if (data.quantity) {
      document.getElementById('quantity').value = data.quantity;
    }
    if (data.unit) {
      var unitSelect = document.getElementById('unit');
      for (var i = 0; i < unitSelect.options.length; i++) {
        if (unitSelect.options[i].value === data.unit) {
          unitSelect.selectedIndex = i;
          break;
        }
      }
    }
    if (data.category) {
      var catSelect = document.getElementById('category');
      for (var i = 0; i < catSelect.options.length; i++) {
        if (catSelect.options[i].value === data.category) {
          catSelect.selectedIndex = i;
          break;
        }
      }
    }

    showResult('success', 'Found: <strong>' + escapeHtml(data.name || barcode) + '</strong>. Review the details below and click Add Item.');
  }

  function showResult(type, html) {
    resultEl.style.display = 'block';
    resultEl.className = 'flash flash-' + type;
    resultEl.innerHTML = html;
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }
})();
</script>

<%- include('../../partials/footer') %>
