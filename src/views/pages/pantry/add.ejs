<%- include('../../partials/header') %>

<div class="flex-between">
  <h1 class="mb-0">Add Pantry Item</h1>
  <button type="button" id="scanBtn" class="outline" onclick="openScanner()">Scan Barcode</button>
</div>

<div id="scanResult" style="display:none;" class="mt-1"></div>

<form method="POST" action="/pantry/add" class="mt-1">
  <input type="hidden" name="_csrf" value="<%= csrfToken %>">
  <input type="hidden" id="barcode" name="barcode">

  <label for="name">Name <span class="danger">*</span></label>
  <input type="text" id="name" name="name" placeholder="e.g. Chicken Breast" required autofocus>

  <div class="grid">
    <div>
      <label for="quantity">Quantity</label>
      <input type="number" id="quantity" name="quantity" step="0.01" min="0" placeholder="1">
    </div>
    <div>
      <label for="unit">Unit</label>
      <select id="unit" name="unit">
        <option value="">-- Select --</option>
        <% if (typeof UNITS !== 'undefined') { %>
          <% UNITS.forEach(function(u) { %>
            <option value="<%= u %>"><%= u %></option>
          <% }); %>
        <% } %>
      </select>
    </div>
  </div>

  <label for="category">Category</label>
  <select id="category" name="category">
    <option value="">-- Select --</option>
    <% if (typeof CATEGORIES !== 'undefined') { %>
      <% CATEGORIES.forEach(function(c) { %>
        <option value="<%= c %>"><%= c %></option>
      <% }); %>
    <% } %>
  </select>

  <label for="expirationDate">Expiration Date</label>
  <input type="date" id="expirationDate" name="expirationDate">

  <label for="notes">Notes</label>
  <textarea id="notes" name="notes" placeholder="Optional notes..."></textarea>

  <div class="grid">
    <button type="submit">Add Item</button>
    <a href="/pantry" role="button" class="outline secondary full-width">Cancel</a>
  </div>
</form>

<dialog id="scannerDialog">
  <article>
    <header>
      <button aria-label="Close" rel="prev" onclick="closeScanner()"></button>
      <h3>Scan Barcode</h3>
    </header>
    <div id="scannerStatus" class="text-center mb-1"></div>
    <div id="reader"></div>
    <footer>
      <button class="outline secondary" onclick="closeScanner()">Cancel</button>
    </footer>
  </article>
</dialog>

<script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
<script>
(function() {
  var scanner = null;
  var scanning = false;
  var dialog = document.getElementById('scannerDialog');
  var scanBtn = document.getElementById('scanBtn');
  var statusEl = document.getElementById('scannerStatus');
  var resultEl = document.getElementById('scanResult');

  // Disable scan button if no camera API
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    scanBtn.textContent = 'Scanner Not Available';
    scanBtn.disabled = true;
  }

  window.openScanner = function() {
    dialog.setAttribute('open', '');
    statusEl.textContent = 'Starting camera...';

    scanner = new Html5Qrcode('reader');
    scanner.start(
      { facingMode: 'environment' },
      { fps: 10, qrbox: { width: 250, height: 150 }, formatsToSupport: [
        Html5QrcodeSupportedFormats.EAN_13,
        Html5QrcodeSupportedFormats.EAN_8,
        Html5QrcodeSupportedFormats.UPC_A,
        Html5QrcodeSupportedFormats.UPC_E,
        Html5QrcodeSupportedFormats.CODE_128,
      ]},
      function(decodedText) {
        onBarcodeScanned(decodedText);
      },
      function() {}
    ).then(function() {
      statusEl.textContent = 'Point camera at a barcode';
    }).catch(function(err) {
      statusEl.textContent = 'Camera error: ' + (err.message || err);
    });
  };

  window.closeScanner = function() {
    if (scanner) {
      scanner.stop().catch(function() {});
      scanner.clear();
      scanner = null;
    }
    dialog.removeAttribute('open');
  };

  function onBarcodeScanned(barcode) {
    if (scanning) return;
    scanning = true;

    if (scanner) {
      scanner.pause(true);
    }
    statusEl.innerHTML = '<span aria-busy="true">Looking up product...</span>';

    var controller = new AbortController();
    var timeoutId = setTimeout(function() { controller.abort(); }, 15000);

    fetch('/pantry/lookup-barcode/' + encodeURIComponent(barcode), { signal: controller.signal })
      .then(function(res) { return res.json(); })
      .then(function(data) {
        clearTimeout(timeoutId);
<<<<<<< HEAD
        scanning = false;
=======
>>>>>>> 6f694f5e46b57a73c228754eb7f7a3dd2864a56e
        closeScanner();
        if (data.found) {
          prefillForm(data, barcode);
        } else {
          showResult('error', 'Product not found for barcode ' + barcode + '. Please enter details manually.');
        }
      })
      .catch(function(err) {
        clearTimeout(timeoutId);
<<<<<<< HEAD
        scanning = false;
=======
>>>>>>> 6f694f5e46b57a73c228754eb7f7a3dd2864a56e
        closeScanner();
        if (err.name === 'AbortError') {
          showResult('error', 'Barcode lookup timed out. Please enter details manually.');
        } else {
          showResult('error', 'Failed to look up barcode. Please enter details manually.');
        }
      });
  }

  function prefillForm(data, barcode) {
    document.getElementById('barcode').value = barcode;

    if (data.name) {
      document.getElementById('name').value = data.name;
    }
    if (data.quantity) {
      document.getElementById('quantity').value = data.quantity;
    }
    if (data.unit) {
      var unitSelect = document.getElementById('unit');
      for (var i = 0; i < unitSelect.options.length; i++) {
        if (unitSelect.options[i].value === data.unit) {
          unitSelect.selectedIndex = i;
          break;
        }
      }
    }
    if (data.category) {
      var catSelect = document.getElementById('category');
      for (var i = 0; i < catSelect.options.length; i++) {
        if (catSelect.options[i].value === data.category) {
          catSelect.selectedIndex = i;
          break;
        }
      }
    }

    showResult('success', 'Found: <strong>' + escapeHtml(data.name || barcode) + '</strong>. Review the details below and click Add Item.');
  }

  function showResult(type, html) {
    resultEl.style.display = 'block';
    resultEl.className = 'flash flash-' + type;
    resultEl.innerHTML = html;
  }

  function escapeHtml(str) {
    var div = document.createElement('div');
    div.appendChild(document.createTextNode(str));
    return div.innerHTML;
  }
})();
</script>

<%- include('../../partials/footer') %>
